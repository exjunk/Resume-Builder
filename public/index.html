<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Resume Builder with Profiles</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-name {
            font-size: 14px;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .auth-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 40px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 4px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .auth-tab.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .main-content {
            padding: 40px;
        }

        .step {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #f0f0f0;
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .step:hover {
            border-color: #4facfe;
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.1);
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .step-number {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .step-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .form-row-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"], input[type="email"], input[type="password"], input[type="url"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4facfe;
        }

        textarea {
            height: 100px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn-mini {
            padding: 4px 8px;
            font-size: 10px;
        }

        .btn-full {
            width: 100%;
            justify-content: center;
        }

        .dropdown-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .dropdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .dropdown-title {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }

        .profile-preview {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-top: 10px;
        }

        .profile-preview h4 {
            margin-bottom: 8px;
            color: #333;
        }

        .profile-preview p {
            margin: 4px 0;
            color: #666;
            font-size: 14px;
        }

        .dynamic-section {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            background: #f9f9f9;
        }

        .dynamic-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .dynamic-title {
            font-weight: 600;
            color: #333;
            flex-grow: 1;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .hidden {
            display: none !important;
        }

        .array-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .array-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .array-item-title {
            font-weight: 600;
            color: #333;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #333;
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .auth-link {
            text-align: center;
            margin-top: 20px;
        }

        .auth-link a {
            color: #4facfe;
            text-decoration: none;
            font-weight: 600;
        }

        .auth-link a:hover {
            text-decoration: underline;
        }

        /* AI Provider Tabs */
        .ai-provider-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .ai-tab {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .ai-tab:hover {
            border-color: #4facfe;
            transform: translateY(-2px);
        }

        .ai-tab.active {
            border-color: #4facfe;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .ai-icon {
            font-size: 20px;
        }

        .ai-name {
            font-weight: 600;
            font-size: 14px;
        }

        .ai-status {
            font-size: 12px;
            opacity: 0.8;
        }

        /* Resume Tabs */
        .resume-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .resume-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .resume-tab.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .tab-icon {
            font-size: 16px;
        }

        .tab-name {
            font-size: 14px;
        }

        /* Resume Content */
        .resume-content {
            display: none;
        }

        .resume-content.active {
            display: block;
        }

        /* Comparison View */
        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .comparison-side {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }

        .comparison-side h3 {
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }

        .comparison-content {
            min-height: 200px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #ddd;
        }

        .comparison-placeholder {
            color: #666;
            text-align: center;
            font-style: italic;
            margin-top: 80px;
        }

        /* AI Status Indicators */
        .ai-status.available {
            color: #28a745;
        }

        .ai-status.unavailable {
            color: #dc3545;
        }

        .ai-status.partial {
            color: #ffc107;
        }

        @media (max-width: 768px) {
            .form-row, .form-row-3, .form-row-4 {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 20px;
            }

            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 20px;
            }

            .auth-container {
                margin: 20px;
                padding: 30px 20px;
            }

            .user-info {
                position: static;
                margin-top: 10px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Section -->
    <div id="authSection" class="hidden">
        <div class="auth-container">
            <div class="auth-header">
                <h2>üéØ ATS Resume Builder</h2>
                <p>Create professional, ATS-optimized resumes</p>
            </div>

            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
                <div class="auth-tab" onclick="switchAuthTab('register')">Register</div>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>
                
                <button type="submit" class="btn btn-full">Login</button>
            </form>

            <!-- Registration Form -->
            <form id="registerForm" class="auth-form">
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" placeholder="Enter your email" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="registerPhone">Phone (Optional)</label>
                        <input type="text" id="registerPhone" placeholder="Your phone number">
                    </div>
                    <div class="form-group">
                        <label for="registerLocation">Location (Optional)</label>
                        <input type="text" id="registerLocation" placeholder="City, State">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" placeholder="Choose a password" required>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
                </div>
                
                <button type="submit" class="btn btn-full">Create Account</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="container hidden">
        <div class="header">
            <h1>üéØ Enhanced Resume Builder</h1>
            <p>Manage profiles, templates, and create ATS-optimized resumes</p>
            
            <div class="user-info">
                <span class="user-name" id="userDisplayName">Welcome!</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="main-content">
            <!-- Profile & Template Selection -->
            <div id="selectionForm">
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">üë§</div>
                        <div class="step-title">Profile & Template Selection</div>
                    </div>
                    
                    <!-- Profile Selection -->
                    <div class="dropdown-section">
                        <div class="dropdown-header">
                            <div class="dropdown-title">üë§ Select Profile</div>
                            <div>
                                <button class="btn btn-small btn-secondary" onclick="openProfileModal()">+ New Profile</button>
                                <button class="btn btn-small" onclick="openProfileModal('edit')" id="editProfileBtn" disabled>‚úèÔ∏è Edit</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <select id="profileSelect" onchange="loadSelectedProfile()">
                                <option value="">Choose a profile...</option>
                            </select>
                        </div>
                        
                        <div id="profilePreview" class="profile-preview hidden">
                            <!-- Profile preview will be populated here -->
                        </div>
                    </div>

                    <!-- Template Selection -->
                    <div class="dropdown-section">
                        <div class="dropdown-header">
                            <div class="dropdown-title">üìù Select Resume Template</div>
                            <div>
                                <button class="btn btn-small btn-secondary" onclick="openTemplateModal()">+ New Template</button>
                                <button class="btn btn-small" onclick="openTemplateModal('edit')" id="editTemplateBtn" disabled>‚úèÔ∏è Edit</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <select id="templateSelect" onchange="loadSelectedTemplate()">
                                <option value="">Choose a template...</option>
                            </select>
                        </div>
                        
                        <div id="templatePreview" class="profile-preview hidden">
                            <!-- Template preview will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Job Details -->
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <div class="step-title">Job Details</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="resumeTitle">Resume Title *</label>
                            <input type="text" id="resumeTitle" placeholder="Senior Developer at TechCorp">
                        </div>
                        <div class="form-group">
                            <label for="companyName">Company Name *</label>
                            <input type="text" id="companyName" placeholder="TechCorp Inc.">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="jobDescription">Job Description *</label>
                        <textarea id="jobDescription" placeholder="Paste the complete job description here..."></textarea>
                    </div>
                </div>

                <!-- Actions -->
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">‚ö°</div>
                        <div class="step-title">Generate Resume</div>
                    </div>
                    
                    <button class="btn btn-success" onclick="generateStructuredResume()">üéØ Generate Optimized Resume</button>
                    <button class="btn btn-secondary" onclick="loadSampleData()">üìù Load Sample Data</button>
                </div>
            </div>

            <!-- Loading Section -->
            <div id="loadingSection" class="loading hidden">
                <div class="spinner"></div>
                <p>Analyzing job requirements and generating structured resume...</p>
            </div>

            <!-- Structured Resume Form -->
            <div id="resumeForm" class="hidden">
                <!-- AI Provider Selection -->
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">ü§ñ</div>
                        <div class="step-title">AI Provider Selection</div>
                    </div>
                    
                    <div class="form-group">
                        <label>Choose AI Provider:</label>
                        <div class="ai-provider-tabs">
                            <button type="button" class="ai-tab active" data-provider="gemini" onclick="switchAIProvider('gemini')">
                                <span class="ai-icon">üî∑</span>
                                <span class="ai-name">Gemini AI</span>
                                <span class="ai-status" id="geminiStatus">Checking...</span>
                            </button>
                            <button type="button" class="ai-tab" data-provider="openai" onclick="switchAIProvider('openai')">
                                <span class="ai-icon">üî∂</span>
                                <span class="ai-name">OpenAI GPT</span>
                                <span class="ai-status" id="openaiStatus">Checking...</span>
                            </button>
                            <button type="button" class="ai-tab" data-provider="both" onclick="switchAIProvider('both')">
                                <span class="ai-icon">üîÑ</span>
                                <span class="ai-name">Both APIs</span>
                                <span class="ai-status" id="bothStatus">Compare</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Resume Content Tabs -->
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">üìÑ</div>
                        <div class="step-title">Resume Content</div>
                    </div>
                    
                    <div class="resume-tabs">
                        <div class="resume-tab active" data-tab="gemini" onclick="switchResumeTab('gemini')">
                            <span class="tab-icon">üî∑</span>
                            <span class="tab-name">Gemini Version</span>
                        </div>
                        <div class="resume-tab" data-tab="openai" onclick="switchResumeTab('openai')">
                            <span class="tab-icon">üî∂</span>
                            <span class="tab-name">OpenAI Version</span>
                        </div>
                        <div class="resume-tab" data-tab="comparison" onclick="switchResumeTab('comparison')">
                            <span class="tab-icon">üìä</span>
                            <span class="tab-name">Comparison</span>
                        </div>
                    </div>
                    
                    <!-- Gemini Resume Content -->
                    <div id="geminiResumeContent" class="resume-content active">
                        <!-- Personal Information -->
                        <div class="step">
                            <div class="step-header">
                                <div class="step-number">üë§</div>
                                <div class="step-title">Personal Information</div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="geminiFormName">Full Name</label>
                                    <input type="text" id="geminiFormName">
                                </div>
                                <div class="form-group">
                                    <label for="geminiFormEmail">Email</label>
                                    <input type="email" id="geminiFormEmail">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="geminiFormLinkedin">LinkedIn URL</label>
                                    <input type="url" id="geminiFormLinkedin" placeholder="https://linkedin.com/in/profile">
                                </div>
                                <div class="form-group">
                                    <label>Mobile Numbers</label>
                                    <div id="geminiMobileNumbersContainer"></div>
                                    <button type="button" class="btn btn-small" onclick="addGeminiMobileNumber()">+ Add Number</button>
                                </div>
                            </div>
                        </div>

                        <!-- Professional Summary -->
                        <div class="step">
                            <div class="step-header">
                                <div class="step-number">üìù</div>
                                <div class="step-title">Professional Summary</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="geminiFormSummary">Professional Summary</label>
                                <textarea id="geminiFormSummary" placeholder="Enter your professional summary..."></textarea>
                            </div>
                        </div>

                        <!-- Professional Experience -->
                        <div class="step">
                            <div class="step-header">
                                <div class="step-number">üíº</div>
                                <div class="step-title">Professional Experience</div>
                            </div>
                            
                            <div id="geminiExperienceContainer"></div>
                            <button type="button" class="btn btn-small" onclick="addGeminiExperience()">+ Add Experience</button>
                        </div>

                        <!-- Skills -->
                        <div class="step">
                            <div class="step-header">
                                <div class="step-number">üîß</div>
                                <div class="step-title">Skills</div>
                            </div>
                            
                            <div id="geminiSkillsContainer"></div>
                            <button type="button" class="btn btn-small" onclick="addGeminiSkillCategory()">+ Add Skill Category</button>
                        </div>

                        <!-- Education -->
                        <div class="step">
                            <div class="step-header">
                                <div class="step-number">üéì</div>
                                <div class="step-title">Education</div>
                            </div>
                            
                            <div id="geminiEducationContainer"></div>
                            <button type="button" class="btn btn-small" onclick="addGeminiEducation()">+ Add Education</button>
                        </div>
                    </div>

                    <!-- OpenAI Resume Content -->
                    <div id="openaiResumeContent" class="resume-content">
                        <!-- Personal Information -->
                        <div class="step">
                            <div class="step-header">
                                <div class="step-number">üë§</div>
                                <div class="step-title">Personal Information</div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="openaiFormName">Full Name</label>
                                    <input type="text" id="openaiFormName">
                                </div>
                                <div class="form-group">
                                    <label for="openaiFormEmail">Email</label>
                                    <input type="email" id="openaiFormEmail">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="openaiFormLinkedin">LinkedIn URL</label>
                                    <input type="url" id="openaiFormLinkedin" placeholder="https://linkedin.com/in/profile">
                                </div>
                                <div class="form-group">
                                    <label>Mobile Numbers</label>
                                    <div id="openaiMobileNumbersContainer"></div>
                                    <button type="button" class="btn btn-small" onclick="addOpenAIMobileNumber()">+ Add Number</button>
                                </div>
                            </div>
                        </div>

                        <!-- Professional Summary -->
                        <div class="step">
                            <div class="step-header">
                                <div class="step-number">üìù</div>
                                <div class="step-title">Professional Summary</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="openaiFormSummary">Professional Summary</label>
                                <textarea id="openaiFormSummary" placeholder="Enter your professional summary..."></textarea>
                            </div>
                        </div>

                        <!-- Professional Experience -->
                        <div class="step">
                            <div class="step-header">
                                <div class="step-number">üíº</div>
                                <div class="step-title">Professional Experience</div>
                            </div>
                            
                            <div id="openaiExperienceContainer"></div>
                            <button type="button" class="btn btn-small" onclick="addOpenAIExperience()">+ Add Experience</button>
                        </div>

                        <!-- Skills -->
                        <div class="step">
                            <div class="step-header">
                                <div class="step-number">üîß</div>
                                <div class="step-title">Skills</div>
                            </div>
                            
                            <div id="openaiSkillsContainer"></div>
                            <button type="button" class="btn btn-small" onclick="addOpenAISkillCategory()">+ Add Skill Category</button>
                        </div>

                        <!-- Education -->
                        <div class="step">
                            <div class="step-header">
                                <div class="step-number">üéì</div>
                                <div class="step-title">Education</div>
                            </div>
                            
                            <div id="openaiEducationContainer"></div>
                            <button type="button" class="btn btn-small" onclick="addOpenAIEducation()">+ Add Education</button>
                        </div>
                    </div>

                    <!-- Comparison View -->
                    <div id="comparisonResumeContent" class="resume-content">
                        <div class="step">
                            <div class="step-header">
                                <div class="step-number">üìä</div>
                                <div class="step-title">Resume Comparison</div>
                            </div>
                            
                            <div class="comparison-container">
                                <div class="comparison-side">
                                    <h3>üî∑ Gemini Version</h3>
                                    <div id="geminiComparisonContent" class="comparison-content">
                                        <p class="comparison-placeholder">Generate resume to see Gemini version</p>
                                    </div>
                                </div>
                                <div class="comparison-side">
                                    <h3>üî∂ OpenAI Version</h3>
                                    <div id="openaiComparisonContent" class="comparison-content">
                                        <p class="comparison-placeholder">Generate resume to see OpenAI version</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">‚ö°</div>
                        <div class="step-title">Actions</div>
                    </div>
                    
                    <button class="btn btn-success" onclick="saveAsNewTemplate()">üíæ Save as Template</button>
                    <button class="btn" onclick="exportToPDFEnhanced()">üìÑ Export to PDF</button>
                    <button class="btn btn-secondary" onclick="exportToJSON()">üìã Export JSON</button>
                    <button class="btn btn-danger" onclick="resetForm()">üîÑ Reset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="profileModalTitle">Create New Profile</div>
                <span class="close" onclick="closeProfileModal()">&times;</span>
            </div>
            
            <form id="profileForm">
                <div class="form-group">
                    <label for="modalProfileName">Profile Name *</label>
                    <input type="text" id="modalProfileName" placeholder="e.g., Personal Profile, Work Profile">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="modalFullName">Full Name *</label>
                        <input type="text" id="modalFullName" placeholder="John Doe">
                    </div>
                    <div class="form-group">
                        <label for="modalEmail">Email *</label>
                        <input type="email" id="modalEmail" placeholder="john@example.com">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="modalLinkedin">LinkedIn URL</label>
                        <input type="url" id="modalLinkedin" placeholder="https://linkedin.com/in/profile">
                    </div>
                    <div class="form-group">
                        <label for="modalLocation">Location</label>
                        <input type="text" id="modalLocation" placeholder="New York, NY">
                    </div>
                </div>

                <div class="form-group">
                    <label>Mobile Numbers</label>
                    <div id="modalMobileContainer"></div>
                    <button type="button" class="btn btn-small" onclick="addModalMobileNumber()">+ Add Number</button>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="modalIsDefault">
                    <label for="modalIsDefault">Set as default profile</label>
                </div>

                <div style="margin-top: 20px;">
                    <button type="button" class="btn btn-success" onclick="saveProfile()">üíæ Save Profile</button>
                    <button type="button" class="btn btn-danger" onclick="deleteProfile()" id="deleteProfileBtn" style="display: none;">üóëÔ∏è Delete</button>
                    <button type="button" class="btn btn-secondary" onclick="closeProfileModal()">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="templateModalTitle">Create New Template</div>
                <span class="close" onclick="closeTemplateModal()">&times;</span>
            </div>
            
            <form id="templateForm">
                <div class="form-group">
                    <label for="modalTemplateName">Template Name *</label>
                    <input type="text" id="modalTemplateName" placeholder="e.g., Software Developer Template">
                </div>
                
                <div class="form-group">
                    <label for="modalResumeContent">Resume Content *</label>
                    <textarea id="modalResumeContent" placeholder="Paste your base resume content here..." style="height: 200px;"></textarea>
                </div>

                <div class="form-group">
                    <label for="modalProfessionalSummary">Professional Summary</label>
                    <textarea id="modalProfessionalSummary" placeholder="Professional summary template..."></textarea>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="modalTemplateIsDefault">
                    <label for="modalTemplateIsDefault">Set as default template</label>
                </div>

                <div style="margin-top: 20px;">
                    <button type="button" class="btn btn-success" onclick="saveTemplate()">üíæ Save Template</button>
                    <button type="button" class="btn btn-danger" onclick="deleteTemplate()" id="deleteTemplateBtn" style="display: none;">üóëÔ∏è Delete</button>
                    <button type="button" class="btn btn-secondary" onclick="closeTemplateModal()">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let structuredResumeData = null;
        let currentResumeUuid = null;
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        let userProfiles = [];
        let resumeTemplates = [];
        let currentProfileUuid = null;
        let currentTemplateUuid = null;
        let editingProfileUuid = null;
        let editingTemplateUuid = null;
        let selectedAIProvider = 'gemini';
        let dualResumeData = null;

        // API Base URL - update this to match your server
        const API_BASE_URL = window.location.origin;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
        });

        // Authentication Functions
        function checkAuthStatus() {
            const token = localStorage.getItem('authToken');
            const userData = localStorage.getItem('userData');
            
            if (token && userData) {
                try {
                    currentUser = JSON.parse(userData);
                    authToken = token;
                    showMainApp();
                    initializeApp();
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    showAuthSection();
                }
            } else {
                showAuthSection();
            }
        }

        function showAuthSection() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            if (currentUser) {
                document.getElementById('userDisplayName').textContent = `Welcome, ${currentUser.fullName}!`;
            }
        }

        function switchAuthTab(tab) {
            // Update tabs
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update forms
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.getElementById(tab + 'Form').classList.add('active');
        }

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAlert('Please fill in all fields', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    // Store auth data
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('userData', JSON.stringify(data.user));
                    
                    authToken = data.token;
                    currentUser = data.user;
                    
                    showAlert('Login successful!', 'success');
                    showMainApp();
                    initializeApp();
                } else {
                    showAlert(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showAlert('Network error. Please try again.', 'error');
            }
        });

        // Registration form handler
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fullName = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const phone = document.getElementById('registerPhone').value.trim();
            const location = document.getElementById('registerLocation').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!fullName || !email || !password || !confirmPassword) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showAlert('Passwords do not match', 'error');
                return;
            }

            if (password.length < 6) {
                showAlert('Password must be at least 6 characters long', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fullName,
                        email,
                        phone: phone || undefined,
                        location: location || undefined,
                        password
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Store auth data
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('userData', JSON.stringify(data.user));
                    
                    authToken = data.token;
                    currentUser = data.user;
                    
                    showAlert('Account created successfully!', 'success');
                    showMainApp();
                    initializeApp();
                } else {
                    showAlert(data.error || 'Registration failed', 'error');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showAlert('Network error. Please try again.', 'error');
            }
        });

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userData');
                authToken = null;
                currentUser = null;
                userProfiles = [];
                resumeTemplates = [];
                showAuthSection();
            }
        }

        // Initialize app after login
        function initializeApp() {
            loadUserProfiles();
            loadResumeTemplates();
            checkAIStatus();
        }

        // Check AI API status
        async function checkAIStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/health/ai`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();

                if (response.ok) {
                    updateAIStatus(data.ai);
                } else {
                    console.error('Failed to check AI status:', data.error);
                }
            } catch (error) {
                console.error('Error checking AI status:', error);
            }
        }

        // Update AI status indicators
        function updateAIStatus(aiData) {
            const geminiStatus = document.getElementById('geminiStatus');
            const openaiStatus = document.getElementById('openaiStatus');
            const bothStatus = document.getElementById('bothStatus');

            if (aiData.gemini) {
                geminiStatus.textContent = aiData.gemini.status === 'Connected' ? '‚úÖ Available' : '‚ùå Unavailable';
                geminiStatus.className = 'ai-status ' + (aiData.gemini.status === 'Connected' ? 'available' : 'unavailable');
            }

            if (aiData.openai) {
                openaiStatus.textContent = aiData.openai.status === 'Connected' ? '‚úÖ Available' : '‚ùå Unavailable';
                openaiStatus.className = 'ai-status ' + (aiData.openai.status === 'Connected' ? 'available' : 'unavailable');
            }

            // Update both status
            const geminiAvailable = aiData.gemini && aiData.gemini.status === 'Connected';
            const openaiAvailable = aiData.openai && aiData.openai.status === 'Connected';
            
            if (geminiAvailable && openaiAvailable) {
                bothStatus.textContent = '‚úÖ Both Available';
                bothStatus.className = 'ai-status available';
            } else if (geminiAvailable || openaiAvailable) {
                bothStatus.textContent = '‚ö†Ô∏è Partial Available';
                bothStatus.className = 'ai-status partial';
            } else {
                bothStatus.textContent = '‚ùå None Available';
                bothStatus.className = 'ai-status unavailable';
            }
        }

        // Switch AI provider
        function switchAIProvider(provider) {
            selectedAIProvider = provider;
            
            // Update active tab
            document.querySelectorAll('.ai-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-provider="${provider}"]`).classList.add('active');
        }

        // Switch resume tab
        function switchResumeTab(tab) {
            // Update active tab
            document.querySelectorAll('.resume-tab').forEach(t => {
                t.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            
            // Update content visibility
            document.querySelectorAll('.resume-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tab + 'ResumeContent').classList.add('active');
            
            // Update comparison view if needed
            if (tab === 'comparison') {
                updateComparisonView();
            }
        }

        // Profile Management Functions
        async function loadUserProfiles() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/profiles`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();

                if (response.ok) {
                    userProfiles = data.profiles;
                    populateProfileDropdown();
                } else {
                    console.error('Failed to load profiles:', data.error);
                }
            } catch (error) {
                console.error('Error loading profiles:', error);
            }
        }

        function populateProfileDropdown() {
            const select = document.getElementById('profileSelect');
            select.innerHTML = '<option value="">Choose a profile...</option>';
            
            userProfiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.profile_uuid;
                option.textContent = `${profile.profile_name}${profile.is_default ? ' (Default)' : ''}`;
                select.appendChild(option);
            });

            // Auto-select default profile
            const defaultProfile = userProfiles.find(p => p.is_default);
            if (defaultProfile) {
                select.value = defaultProfile.profile_uuid;
                loadSelectedProfile();
            }
        }

        async function loadSelectedProfile() {
            const profileUuid = document.getElementById('profileSelect').value;
            const editBtn = document.getElementById('editProfileBtn');
            
            if (!profileUuid) {
                document.getElementById('profilePreview').classList.add('hidden');
                editBtn.disabled = true;
                currentProfileUuid = null;
                return;
            }

            currentProfileUuid = profileUuid;
            editBtn.disabled = false;

            const profile = userProfiles.find(p => p.profile_uuid === profileUuid);
            if (profile) {
                displayProfilePreview(profile);
            }
        }

        function displayProfilePreview(profile) {
            const preview = document.getElementById('profilePreview');
            preview.innerHTML = `
                <h4>${profile.profile_name}</h4>
                <p><strong>Name:</strong> ${profile.full_name}</p>
                <p><strong>Email:</strong> ${profile.email}</p>
                <p><strong>Mobile:</strong> ${profile.mobile_numbers.join(', ') || 'Not provided'}</p>
                <p><strong>LinkedIn:</strong> ${profile.linkedin_url || 'Not provided'}</p>
                <p><strong>Location:</strong> ${profile.location || 'Not provided'}</p>
            `;
            preview.classList.remove('hidden');
        }

        // Template Management Functions
        async function loadResumeTemplates() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/templates`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();

                if (response.ok) {
                    resumeTemplates = data.templates;
                    populateTemplateDropdown();
                } else {
                    console.error('Failed to load templates:', data.error);
                }
            } catch (error) {
                console.error('Error loading templates:', error);
            }
        }

        function populateTemplateDropdown() {
            const select = document.getElementById('templateSelect');
            select.innerHTML = '<option value="">Choose a template...</option>';
            
            resumeTemplates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.template_uuid;
                option.textContent = `${template.template_name}${template.is_default ? ' (Default)' : ''}`;
                select.appendChild(option);
            });

            // Auto-select default template
            const defaultTemplate = resumeTemplates.find(t => t.is_default);
            if (defaultTemplate) {
                select.value = defaultTemplate.template_uuid;
                loadSelectedTemplate();
            }
        }

        async function loadSelectedTemplate() {
            const templateUuid = document.getElementById('templateSelect').value;
            const editBtn = document.getElementById('editTemplateBtn');
            
            if (!templateUuid) {
                document.getElementById('templatePreview').classList.add('hidden');
                editBtn.disabled = true;
                currentTemplateUuid = null;
                return;
            }

            currentTemplateUuid = templateUuid;
            editBtn.disabled = false;

            const template = resumeTemplates.find(t => t.template_uuid === templateUuid);
            if (template) {
                displayTemplatePreview(template);
            }
        }

        function displayTemplatePreview(template) {
            const preview = document.getElementById('templatePreview');
            const contentPreview = template.resume_content ? 
                template.resume_content.substring(0, 150) + '...' : 'No content';
            
            preview.innerHTML = `
                <h4>${template.template_name}</h4>
                <p><strong>Summary:</strong> ${template.professional_summary || 'Not provided'}</p>
                <p><strong>Content:</strong> ${contentPreview}</p>
                <p><strong>Created:</strong> ${new Date(template.created_at).toLocaleDateString()}</p>
            `;
            preview.classList.remove('hidden');
        }

        // Modal Functions
        function openProfileModal(mode = 'create') {
            const modal = document.getElementById('profileModal');
            const title = document.getElementById('profileModalTitle');
            const deleteBtn = document.getElementById('deleteProfileBtn');
            
            if (mode === 'edit' && currentProfileUuid) {
                title.textContent = 'Edit Profile';
                deleteBtn.style.display = 'inline-block';
                editingProfileUuid = currentProfileUuid;
                
                const profile = userProfiles.find(p => p.profile_uuid === currentProfileUuid);
                if (profile) {
                    populateProfileModal(profile);
                }
            } else {
                title.textContent = 'Create New Profile';
                deleteBtn.style.display = 'none';
                editingProfileUuid = null;
                clearProfileModal();
            }
            
            modal.style.display = 'block';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
            clearProfileModal();
        }

        function populateProfileModal(profile) {
            document.getElementById('modalProfileName').value = profile.profile_name;
            document.getElementById('modalFullName').value = profile.full_name;
            document.getElementById('modalEmail').value = profile.email;
            document.getElementById('modalLinkedin').value = profile.linkedin_url || '';
            document.getElementById('modalLocation').value = profile.location || '';
            document.getElementById('modalIsDefault').checked = profile.is_default;
            
            populateModalMobileNumbers(profile.mobile_numbers);
        }

        function clearProfileModal() {
            document.getElementById('profileForm').reset();
            document.getElementById('modalMobileContainer').innerHTML = '';
            addModalMobileNumber(); // Add one empty field
            editingProfileUuid = null;
        }

        function populateModalMobileNumbers(numbers) {
            const container = document.getElementById('modalMobileContainer');
            container.innerHTML = '';
            
            if (numbers && numbers.length > 0) {
                numbers.forEach(number => addModalMobileNumber(number));
            } else {
                addModalMobileNumber('');
            }
        }

        function addModalMobileNumber(value = '') {
            const container = document.getElementById('modalMobileContainer');
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.gap = '10px';
            div.style.marginBottom = '10px';
            div.innerHTML = `
                <input type="text" placeholder="Mobile number" value="${value}" style="flex: 1;">
                <button type="button" class="btn btn-mini btn-danger" onclick="removeModalMobileNumber(this)">√ó</button>
            `;
            container.appendChild(div);
        }

        function removeModalMobileNumber(button) {
            button.parentElement.remove();
            
            // Ensure at least one field exists
            const container = document.getElementById('modalMobileContainer');
            if (container.children.length === 0) {
                addModalMobileNumber('');
            }
        }

        async function saveProfile() {
            const profileName = document.getElementById('modalProfileName').value.trim();
            const fullName = document.getElementById('modalFullName').value.trim();
            const email = document.getElementById('modalEmail').value.trim();
            
            if (!profileName || !fullName || !email) {
                showAlert('Profile name, full name, and email are required', 'error');
                return;
            }

            const mobileInputs = document.querySelectorAll('#modalMobileContainer input');
            const mobileNumbers = Array.from(mobileInputs)
                .map(input => input.value.trim())
                .filter(num => num);

            const profileData = {
                profileName,
                fullName,
                email,
                mobileNumbers,
                linkedinUrl: document.getElementById('modalLinkedin').value.trim(),
                location: document.getElementById('modalLocation').value.trim(),
                isDefault: document.getElementById('modalIsDefault').checked
            };

            try {
                const url = editingProfileUuid ? 
                    `${API_BASE_URL}/api/profiles/${editingProfileUuid}` : 
                    `${API_BASE_URL}/api/profiles`;
                const method = editingProfileUuid ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(profileData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert(`Profile ${editingProfileUuid ? 'updated' : 'created'} successfully!`, 'success');
                    closeProfileModal();
                    await loadUserProfiles();
                } else {
                    showAlert(data.error || 'Failed to save profile', 'error');
                }
            } catch (error) {
                showAlert('Error saving profile: ' + error.message, 'error');
            }
        }

        async function deleteProfile() {
            if (!editingProfileUuid) return;
            
            if (!confirm('Are you sure you want to delete this profile?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/profiles/${editingProfileUuid}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Profile deleted successfully!', 'success');
                    closeProfileModal();
                    await loadUserProfiles();
                } else {
                    showAlert(data.error || 'Failed to delete profile', 'error');
                }
            } catch (error) {
                showAlert('Error deleting profile: ' + error.message, 'error');
            }
        }

        // Template Modal Functions
        function openTemplateModal(mode = 'create') {
            const modal = document.getElementById('templateModal');
            const title = document.getElementById('templateModalTitle');
            const deleteBtn = document.getElementById('deleteTemplateBtn');
            
            if (mode === 'edit' && currentTemplateUuid) {
                title.textContent = 'Edit Template';
                deleteBtn.style.display = 'inline-block';
                editingTemplateUuid = currentTemplateUuid;
                
                loadTemplateForEditing(currentTemplateUuid);
            } else {
                title.textContent = 'Create New Template';
                deleteBtn.style.display = 'none';
                editingTemplateUuid = null;
                clearTemplateModal();
            }
            
            modal.style.display = 'block';
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').style.display = 'none';
            clearTemplateModal();
        }

        async function loadTemplateForEditing(templateUuid) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/templates/${templateUuid}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();

                if (response.ok) {
                    const template = data.template;
                    document.getElementById('modalTemplateName').value = template.template_name;
                    document.getElementById('modalResumeContent').value = template.resume_content;
                    document.getElementById('modalProfessionalSummary').value = template.professional_summary || '';
                    document.getElementById('modalTemplateIsDefault').checked = template.is_default;
                } else {
                    showAlert(data.error || 'Failed to load template', 'error');
                }
            } catch (error) {
                showAlert('Error loading template: ' + error.message, 'error');
            }
        }

        function clearTemplateModal() {
            document.getElementById('templateForm').reset();
            editingTemplateUuid = null;
        }

        async function saveTemplate() {
            const templateName = document.getElementById('modalTemplateName').value.trim();
            const resumeContent = document.getElementById('modalResumeContent').value.trim();
            
            if (!templateName || !resumeContent) {
                showAlert('Template name and resume content are required', 'error');
                return;
            }

            const templateData = {
                templateName,
                resumeContent,
                professionalSummary: document.getElementById('modalProfessionalSummary').value.trim(),
                skills: [], // Will be populated from form data if needed
                experience: [],
                education: [],
                isDefault: document.getElementById('modalTemplateIsDefault').checked
            };

            try {
                const url = editingTemplateUuid ? 
                    `${API_BASE_URL}/api/templates/${editingTemplateUuid}` : 
                    `${API_BASE_URL}/api/templates`;
                const method = editingTemplateUuid ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(templateData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert(`Template ${editingTemplateUuid ? 'updated' : 'created'} successfully!`, 'success');
                    closeTemplateModal();
                    await loadResumeTemplates();
                } else {
                    showAlert(data.error || 'Failed to save template', 'error');
                }
            } catch (error) {
                showAlert('Error saving template: ' + error.message, 'error');
            }
        }

        async function deleteTemplate() {
            if (!editingTemplateUuid) return;
            
            if (!confirm('Are you sure you want to delete this template?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/templates/${editingTemplateUuid}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Template deleted successfully!', 'success');
                    closeTemplateModal();
                    await loadResumeTemplates();
                } else {
                    showAlert(data.error || 'Failed to delete template', 'error');
                }
            } catch (error) {
                showAlert('Error deleting template: ' + error.message, 'error');
            }
        }

        // Resume Generation Functions
        async function generateStructuredResume() {
            const jobDescription = document.getElementById('jobDescription').value.trim();
            const resumeTitle = document.getElementById('resumeTitle').value.trim();
            const companyName = document.getElementById('companyName').value.trim();

            if (!jobDescription || !resumeTitle || !companyName) {
                showAlert('Please fill in job description, resume title, and company name', 'error');
                return;
            }

            if (!currentProfileUuid) {
                showAlert('Please select a profile first', 'error');
                return;
            }

            if (!currentTemplateUuid) {
                showAlert('Please select a resume template first', 'error');
                return;
            }

            showLoading();

            try {
                // Fetch full template content from backend
                const templateResponse = await fetch(`${API_BASE_URL}/api/templates/${currentTemplateUuid}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const templateData = await templateResponse.json();

                if (!templateResponse.ok) {
                    throw new Error(templateData.error || 'Failed to load template');
                }

                const template = templateData.template;
                let resumeContent = template.resume_content || '';

                // If template content is empty, provide a basic structure
                if (!resumeContent.trim()) {
                    resumeContent = `Professional Summary:
${template.professional_summary || 'Experienced professional seeking new opportunities.'}

Experience:
[Previous work experience will be enhanced based on job requirements]

Skills:
[Skills will be optimized based on job description]

Education:
[Educational background]
`;
                }

                console.log('Sending to backend:', {
                    jobDescription: jobDescription.substring(0, 100) + '...',
                    resumeContentLength: resumeContent.length,
                    profileUuid: currentProfileUuid,
                    templateUuid: currentTemplateUuid,
                    aiProvider: selectedAIProvider
                });

                let response;
                if (selectedAIProvider === 'both') {
                    response = await fetch(`${API_BASE_URL}/api/resumes/optimize-dual`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            jobDescription,
                            resumeText: resumeContent,
                            profileUuid: currentProfileUuid,
                            templateUuid: currentTemplateUuid
                        })
                    });
                } else {
                    response = await fetch(`${API_BASE_URL}/api/resumes/optimize`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            jobDescription,
                            resumeText: resumeContent,
                            profileUuid: currentProfileUuid,
                            templateUuid: currentTemplateUuid,
                            aiProvider: selectedAIProvider
                        })
                    });
                }

                const data = await response.json();

                if (response.ok) {
                    if (selectedAIProvider === 'both') {
                        dualResumeData = data.optimizedResumeData;
                        populateDualResumeForm(dualResumeData);
                    } else {
                        structuredResumeData = data.optimizedResumeData;
                        populateResumeForm(structuredResumeData, selectedAIProvider);
                    }
                    hideLoading();
                    showResumeForm();
                    showAlert('Structured resume generated successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Failed to generate structured resume');
                }
            } catch (error) {
                hideLoading();
                showAlert('Error: ' + error.message, 'error');
                console.error('Full error:', error);
            }
        }

        // Save current form data as new template
        async function saveAsNewTemplate() {
            const formData = collectFormData();
            
            const templateName = prompt('Enter a name for this template:');
            if (!templateName) return;

            const templateData = {
                templateName,
                resumeContent: generateResumeText(formData),
                professionalSummary: formData.professionalSummary,
                skills: formData.skills,
                experience: formData.professionalExperience,
                education: formData.education,
                isDefault: false
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/templates`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(templateData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Template saved successfully!', 'success');
                    await loadResumeTemplates();
                } else {
                    showAlert(data.error || 'Failed to save template', 'error');
                }
            } catch (error) {
                showAlert('Error saving template: ' + error.message, 'error');
            }
        }

        function generateResumeText(formData) {
            let text = `${formData.name}\n`;
            text += `${formData.email} | ${formData.mobileNumbers.join(' | ')} | ${formData.linkedinUrl}\n\n`;
            
            if (formData.professionalSummary) {
                text += `PROFESSIONAL SUMMARY\n${formData.professionalSummary}\n\n`;
            }
            
            if (formData.professionalExperience.length > 0) {
                text += `PROFESSIONAL EXPERIENCE\n`;
                formData.professionalExperience.forEach(exp => {
                    text += `${exp.jobDesignation} | ${exp.jobName} | ${exp.term}\n`;
                    exp.jobDetails.forEach(detail => {
                        text += `‚Ä¢ ${detail}\n`;
                    });
                    text += '\n';
                });
            }
            
            if (formData.skills.length > 0) {
                text += `SKILLS\n`;
                formData.skills.forEach(skillCategory => {
                    text += `${skillCategory.skillName}: ${skillCategory.skills.join(', ')}\n`;
                });
                text += '\n';
            }
            
            if (formData.education.length > 0) {
                text += `EDUCATION\n`;
                formData.education.forEach(edu => {
                    text += `${edu.degree} | ${edu.collegeName} | ${edu.tenure}\n`;
                });
            }
            
            return text;
        }

        // Resume form management functions
        function populateResumeForm(data, provider = 'gemini') {
            const prefix = provider === 'openai' ? 'openai' : 'gemini';
            
            document.getElementById(prefix + 'FormName').value = data.name || '';
            document.getElementById(prefix + 'FormEmail').value = data.email || '';
            document.getElementById(prefix + 'FormLinkedin').value = data.linkedinUrl || '';
            document.getElementById(prefix + 'FormSummary').value = data.professionalSummary || '';

            // Populate mobile numbers
            populateMobileNumbers(data.mobileNumbers || [], prefix);
            
            // Populate experience
            populateExperience(data.professionalExperience || [], prefix);
            
            // Populate skills
            populateSkills(data.skills || [], prefix);
            
            // Populate education
            populateEducation(data.education || [], prefix);
        }

        // Populate dual resume forms
        function populateDualResumeForm(data) {
            if (data.gemini) {
                populateResumeForm(data.gemini, 'gemini');
            }
            if (data.openai) {
                populateResumeForm(data.openai, 'openai');
            }
            
            // Update comparison view
            updateComparisonView();
        }

        // Update comparison view
        function updateComparisonView() {
            if (!dualResumeData) return;
            
            const geminiContent = document.getElementById('geminiComparisonContent');
            const openaiContent = document.getElementById('openaiComparisonContent');
            
            if (dualResumeData.gemini) {
                geminiContent.innerHTML = formatResumeForComparison(dualResumeData.gemini);
            } else {
                geminiContent.innerHTML = '<p class="comparison-placeholder">Gemini version not available</p>';
            }
            
            if (dualResumeData.openai) {
                openaiContent.innerHTML = formatResumeForComparison(dualResumeData.openai);
            } else {
                openaiContent.innerHTML = '<p class="comparison-placeholder">OpenAI version not available</p>';
            }
        }

        // Format resume for comparison view
        function formatResumeForComparison(data) {
            let html = '<div class="comparison-resume">';
            
            // Header
            html += `<h4>${data.name || 'Name'}</h4>`;
            html += `<p><strong>Email:</strong> ${data.email || 'N/A'}</p>`;
            if (data.mobileNumbers && data.mobileNumbers.length > 0) {
                html += `<p><strong>Phone:</strong> ${data.mobileNumbers.join(', ')}</p>`;
            }
            if (data.linkedinUrl) {
                html += `<p><strong>LinkedIn:</strong> ${data.linkedinUrl}</p>`;
            }
            
            // Summary
            if (data.professionalSummary) {
                html += '<h5>Professional Summary</h5>';
                html += `<p>${data.professionalSummary}</p>`;
            }
            
            // Experience
            if (data.professionalExperience && data.professionalExperience.length > 0) {
                html += '<h5>Professional Experience</h5>';
                data.professionalExperience.forEach(exp => {
                    html += `<div class="exp-item">`;
                    html += `<strong>${exp.jobDesignation || 'Title'}</strong> - ${exp.jobName || 'Company'}<br>`;
                    html += `<em>${exp.term || 'Period'}</em><br>`;
                    if (exp.jobDetails && exp.jobDetails.length > 0) {
                        html += '<ul>';
                        exp.jobDetails.forEach(detail => {
                            html += `<li>${detail}</li>`;
                        });
                        html += '</ul>';
                    }
                    html += '</div>';
                });
            }
            
            // Skills
            if (data.skills && data.skills.length > 0) {
                html += '<h5>Skills</h5>';
                data.skills.forEach(skill => {
                    html += `<p><strong>${skill.skillName}:</strong> ${skill.skills.join(', ')}</p>`;
                });
            }
            
            // Education
            if (data.education && data.education.length > 0) {
                html += '<h5>Education</h5>';
                data.education.forEach(edu => {
                    html += `<p><strong>${edu.degree || 'Degree'}</strong><br>`;
                    html += `${edu.collegeName || 'Institution'} | ${edu.tenure || 'Period'}</p>`;
                });
            }
            
            html += '</div>';
            return html;
        }

        function collectFormData(provider = 'gemini') {
            const prefix = provider === 'openai' ? 'openai' : 'gemini';
            
            // Personal info
            const name = document.getElementById(prefix + 'FormName').value;
            const email = document.getElementById(prefix + 'FormEmail').value;
            const linkedin = document.getElementById(prefix + 'FormLinkedin').value;
            const summary = document.getElementById(prefix + 'FormSummary').value;

            // Mobile numbers
            const mobileInputs = document.querySelectorAll(`#${prefix}MobileNumbersContainer input`);
            const mobileNumbers = Array.from(mobileInputs).map(input => input.value.trim()).filter(num => num);

            // Experience
            const experienceItems = document.querySelectorAll(`#${prefix}ExperienceContainer .array-item`);
            const professionalExperience = Array.from(experienceItems).map(item => ({
                jobName: item.querySelector('[name="jobName"]').value,
                jobDesignation: item.querySelector('[name="jobDesignation"]').value,
                term: item.querySelector('[name="term"]').value,
                jobDetails: item.querySelector('[name="jobDetails"]').value.split('\n').filter(detail => detail.trim())
            })).filter(exp => exp.jobName || exp.jobDesignation);

            // Skills
            const skillItems = document.querySelectorAll(`#${prefix}SkillsContainer .array-item`);
            const skills = Array.from(skillItems).map(item => ({
                skillName: item.querySelector('[name="skillName"]').value,
                skills: item.querySelector('[name="skills"]').value.split(',').map(s => s.trim()).filter(s => s)
            })).filter(skill => skill.skillName);

            // Education
            const educationItems = document.querySelectorAll(`#${prefix}EducationContainer .array-item`);
            const education = Array.from(educationItems).map(item => ({
                degree: item.querySelector('[name="degree"]').value,
                collegeName: item.querySelector('[name="collegeName"]').value,
                tenure: item.querySelector('[name="tenure"]').value
            })).filter(edu => edu.degree || edu.collegeName);

            return {
                name,
                email,
                mobileNumbers,
                linkedinUrl: linkedin,
                professionalSummary: summary,
                professionalExperience,
                skills,
                education
            };
        }

        // Mobile numbers management
        function populateMobileNumbers(numbers, prefix = 'gemini') {
            const container = document.getElementById(prefix + 'MobileNumbersContainer');
            container.innerHTML = '';
            
            numbers.forEach((number, index) => {
                addMobileNumberInput(number, index, prefix);
            });
            
            if (numbers.length === 0) {
                addMobileNumberInput('', 0, prefix);
            }
        }

        function addMobileNumber() {
            const container = document.getElementById('geminiMobileNumbersContainer');
            const index = container.children.length;
            addMobileNumberInput('', index, 'gemini');
        }

        function addGeminiMobileNumber() {
            const container = document.getElementById('geminiMobileNumbersContainer');
            const index = container.children.length;
            addMobileNumberInput('', index, 'gemini');
        }

        function addOpenAIMobileNumber() {
            const container = document.getElementById('openaiMobileNumbersContainer');
            const index = container.children.length;
            addMobileNumberInput('', index, 'openai');
        }

        function addMobileNumberInput(value, index, prefix) {
            const container = document.getElementById(prefix + 'MobileNumbersContainer');
            const div = document.createElement('div');
            div.className = 'form-group';
            div.innerHTML = `
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                    <input type="text" placeholder="Mobile number" value="${value}">
                    <button type="button" class="btn btn-small btn-danger" onclick="removeMobileNumber(this)">√ó</button>
                </div>
            `;
            container.appendChild(div);
        }

        function removeMobileNumber(button) {
            button.closest('.form-group').remove();
        }

        // Experience management
        function populateExperience(experiences, prefix = 'gemini') {
            const container = document.getElementById(prefix + 'ExperienceContainer');
            container.innerHTML = '';
            
            experiences.forEach((exp, index) => {
                addExperienceItem(exp, index, prefix);
            });
            
            if (experiences.length === 0) {
                addExperienceItem({}, 0, prefix);
            }
        }

        function addExperience() {
            const container = document.getElementById('geminiExperienceContainer');
            const index = container.children.length;
            addExperienceItem({}, index, 'gemini');
        }

        function addGeminiExperience() {
            const container = document.getElementById('geminiExperienceContainer');
            const index = container.children.length;
            addExperienceItem({}, index, 'gemini');
        }

        function addOpenAIExperience() {
            const container = document.getElementById('openaiExperienceContainer');
            const index = container.children.length;
            addExperienceItem({}, index, 'openai');
        }

        function addExperienceItem(exp, index, prefix) {
            const container = document.getElementById(prefix + 'ExperienceContainer');
            const div = document.createElement('div');
            div.className = 'array-item';
            div.innerHTML = `
                <div class="array-item-header">
                    <div class="array-item-title">Experience ${index + 1}</div>
                    <button type="button" class="btn btn-small btn-danger" onclick="removeExperience(this)">Remove</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Company Name</label>
                        <input type="text" name="jobName" value="${exp.jobName || ''}" placeholder="Company Name">
                    </div>
                    <div class="form-group">
                        <label>Job Title</label>
                        <input type="text" name="jobDesignation" value="${exp.jobDesignation || ''}" placeholder="Job Title">
                    </div>
                </div>
                <div class="form-group">
                    <label>Term</label>
                    <input type="text" name="term" value="${exp.term || ''}" placeholder="Jan 2020 - Present">
                </div>
                <div class="form-group">
                    <label>Job Details (one per line)</label>
                    <textarea name="jobDetails" placeholder="‚Ä¢ Achievement 1&#10;‚Ä¢ Achievement 2&#10;‚Ä¢ Achievement 3">${(exp.jobDetails || []).join('\n')}</textarea>
                </div>
            `;
            container.appendChild(div);
        }

        function removeExperience(button) {
            button.closest('.array-item').remove();
        }

        // Skills management
        function populateSkills(skills, prefix = 'gemini') {
            const container = document.getElementById(prefix + 'SkillsContainer');
            container.innerHTML = '';
            
            skills.forEach((skill, index) => {
                addSkillCategoryItem(skill, index, prefix);
            });
            
            if (skills.length === 0) {
                addSkillCategoryItem({}, 0, prefix);
            }
        }

        function addSkillCategory() {
            const container = document.getElementById('geminiSkillsContainer');
            const index = container.children.length;
            addSkillCategoryItem({}, index, 'gemini');
        }

        function addGeminiSkillCategory() {
            const container = document.getElementById('geminiSkillsContainer');
            const index = container.children.length;
            addSkillCategoryItem({}, index, 'gemini');
        }

        function addOpenAISkillCategory() {
            const container = document.getElementById('openaiSkillsContainer');
            const index = container.children.length;
            addSkillCategoryItem({}, index, 'openai');
        }

        function addSkillCategoryItem(skill, index, prefix) {
            const container = document.getElementById(prefix + 'SkillsContainer');
            const div = document.createElement('div');
            div.className = 'array-item';
            div.innerHTML = `
                <div class="array-item-header">
                    <div class="array-item-title">Skill Category ${index + 1}</div>
                    <button type="button" class="btn btn-small btn-danger" onclick="removeSkillCategory(this)">Remove</button>
                </div>
                <div class="form-group">
                    <label>Category Name</label>
                    <input type="text" name="skillName" value="${skill.skillName || ''}" placeholder="e.g., Programming Languages">
                </div>
                <div class="form-group">
                    <label>Skills (comma-separated)</label>
                    <input type="text" name="skills" value="${(skill.skills || []).join(', ')}" placeholder="JavaScript, Python, React">
                </div>
            `;
            container.appendChild(div);
        }

        function removeSkillCategory(button) {
            button.closest('.array-item').remove();
        }

        // Education management
        function populateEducation(education, prefix = 'gemini') {
            const container = document.getElementById(prefix + 'EducationContainer');
            container.innerHTML = '';
            
            education.forEach((edu, index) => {
                addEducationItem(edu, index, prefix);
            });
            
            if (education.length === 0) {
                addEducationItem({}, 0, prefix);
            }
        }

        function addEducation() {
            const container = document.getElementById('geminiEducationContainer');
            const index = container.children.length;
            addEducationItem({}, index, 'gemini');
        }

        function addGeminiEducation() {
            const container = document.getElementById('geminiEducationContainer');
            const index = container.children.length;
            addEducationItem({}, index, 'gemini');
        }

        function addOpenAIEducation() {
            const container = document.getElementById('openaiEducationContainer');
            const index = container.children.length;
            addEducationItem({}, index, 'openai');
        }

        function addEducationItem(edu, index, prefix) {
            const container = document.getElementById(prefix + 'EducationContainer');
            const div = document.createElement('div');
            div.className = 'array-item';
            div.innerHTML = `
                <div class="array-item-header">
                    <div class="array-item-title">Education ${index + 1}</div>
                    <button type="button" class="btn btn-small btn-danger" onclick="removeEducation(this)">Remove</button>
                </div>
                <div class="form-group">
                    <label>Degree</label>
                    <input type="text" name="degree" value="${edu.degree || ''}" placeholder="Bachelor of Science in Computer Science">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>College/University</label>
                        <input type="text" name="collegeName" value="${edu.collegeName || ''}" placeholder="University Name">
                    </div>
                    <div class="form-group">
                        <label>Tenure</label>
                        <input type="text" name="tenure" value="${edu.tenure || ''}" placeholder="2018 - 2022">
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function removeEducation(button) {
            button.closest('.array-item').remove();
        }

        // Load sample data
        function loadSampleData() {
            document.getElementById('resumeTitle').value = 'Senior Full Stack Developer at TechCorp';
            document.getElementById('companyName').value = 'TechCorp Inc.';
            
            document.getElementById('jobDescription').value = `We are seeking a Senior Full Stack Developer to join our growing team. 

Required Skills:
- 5+ years of experience in full-stack development
- Proficiency in JavaScript, React, Node.js
- Experience with databases (PostgreSQL, MongoDB)
- Knowledge of cloud platforms (AWS, Azure)
- Strong problem-solving skills
- Experience with Agile methodologies

Responsibilities:
- Develop and maintain web applications
- Collaborate with cross-functional teams
- Mentor junior developers
- Participate in code reviews
- Optimize application performance`;

            showAlert('Sample data loaded successfully!', 'success');
        }

        // Export functions
        function exportToPDF() {
            const formData = collectFormData(selectedAIProvider);
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPosition = 20;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 20;
                const lineHeight = 6;
                
                // Helper function to check page break
                function checkPageBreak(neededSpace = 10) {
                    if (yPosition > pageHeight - margin - neededSpace) {
                        doc.addPage();
                        yPosition = margin;
                        return true;
                    }
                    return false;
                }

                // Helper function to add text with wrapping
                function addText(text, fontSize = 10, fontStyle = 'normal', leftMargin = margin) {
                    doc.setFontSize(fontSize);
                    doc.setFont('helvetica', fontStyle);
                    
                    const maxWidth = 170;
                    const lines = doc.splitTextToSize(text, maxWidth);
                    
                    lines.forEach(line => {
                        checkPageBreak();
                        doc.text(line, leftMargin, yPosition);
                        yPosition += lineHeight;
                    });
                }

                // Header - Name and Contact
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text(formData.name, margin, yPosition);
                yPosition += 10;

                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                const contactInfo = [
                    formData.email,
                    ...formData.mobileNumbers,
                    formData.linkedinUrl
                ].filter(item => item).join(' | ');
                doc.text(contactInfo, margin, yPosition);
                yPosition += 15;

                // Professional Summary
                if (formData.professionalSummary) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PROFESSIONAL SUMMARY', margin, yPosition);
                    yPosition += 8;
                    
                    addText(formData.professionalSummary);
                    yPosition += 5;
                }

                // Professional Experience
                if (formData.professionalExperience.length > 0) {
                    checkPageBreak(15);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PROFESSIONAL EXPERIENCE', margin, yPosition);
                    yPosition += 8;

                    formData.professionalExperience.forEach(exp => {
                        checkPageBreak(20);
                        
                        // Job title and company
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${exp.jobDesignation} - ${exp.jobName}`, margin, yPosition);
                        yPosition += 6;
                        
                        // Term
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'italic');
                        doc.text(exp.term, margin, yPosition);
                        yPosition += 8;
                        
                        // Job details
                        doc.setFont('helvetica', 'normal');
                        exp.jobDetails.forEach(detail => {
                            addText(`‚Ä¢ ${detail}`, 10, 'normal', margin + 5);
                        });
                        yPosition += 5;
                    });
                }

                // Skills
                if (formData.skills.length > 0) {
                    checkPageBreak(15);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('SKILLS', margin, yPosition);
                    yPosition += 8;

                    formData.skills.forEach(skillCategory => {
                        checkPageBreak();
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${skillCategory.skillName}:`, margin, yPosition);
                        
                        doc.setFont('helvetica', 'normal');
                        const skillsText = skillCategory.skills.join(', ');
                        addText(skillsText, 10, 'normal', margin + 50);
                        yPosition += 3;
                    });
                }

                // Education
                if (formData.education.length > 0) {
                    checkPageBreak(15);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('EDUCATION', margin, yPosition);
                    yPosition += 8;

                    formData.education.forEach(edu => {
                        checkPageBreak();
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text(edu.degree, margin, yPosition);
                        yPosition += 6;
                        
                        doc.setFont('helvetica', 'normal');
                        doc.text(`${edu.collegeName} | ${edu.tenure}`, margin, yPosition);
                        yPosition += 8;
                    });
                }

                // Save PDF
                const fileName = `${formData.name.replace(/[^a-zA-Z0-9]/g, '_')}_Resume.pdf`;
                doc.save(fileName);
                
                showAlert('PDF exported successfully!', 'success');
                
            } catch (error) {
                showAlert('Error generating PDF: ' + error.message, 'error');
            }
        }

        // Enhanced PDF Export Function with Beautiful Formatting
// Customized Enhanced PDF Export Function
// Customized Enhanced PDF Export Function

// Customized Enhanced PDF Export Function - Single Page
        function exportToPDFEnhanced() {
            const formData = collectFormData(selectedAIProvider);
    
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        // Page dimensions
        const pageWidth = 210;
        const pageHeight = 297;
        const margin = 20;
        const contentWidth = pageWidth - (margin * 2);
        const availableHeight = pageHeight - (margin * 2) - 15; // Reserve space for footer
        
        // Colors - Changed from blue to black
        const primaryColor = [0, 0, 0]; // Black instead of blue
        const secondaryColor = [108, 117, 125]; // Gray
        const accentColor = [40, 167, 69]; // Green
        const textColor = [33, 37, 41]; // Dark
        const separatorColor = [0, 0, 0]; // Black separator
        
        let yPosition = margin;
        let scaleFactor = 1; // Will be adjusted based on content
        
        // Calculate estimated content height to determine scaling
        function calculateEstimatedHeight() {
            let estimatedHeight = 0;
            
            // Header (name + contact)
            estimatedHeight += 25;
            
            // Professional Summary
            if (formData.professionalSummary) {
                const summaryLines = Math.ceil(formData.professionalSummary.length / 80);
                estimatedHeight += 20 + (summaryLines * 5);
            }
            
            // Experience
            if (formData.professionalExperience?.length > 0) {
                estimatedHeight += 15; // Section header
                formData.professionalExperience.forEach(exp => {
                    estimatedHeight += 15; // Job header
                    estimatedHeight += (exp.jobDetails?.length || 0) * 6; // Achievements
                    estimatedHeight += 5; // Spacing
                });
            }
            
            // Skills
            if (formData.skills?.length > 0) {
                estimatedHeight += 15; // Section header
                estimatedHeight += formData.skills.length * 8;
            }
            
            // Education
            if (formData.education?.length > 0) {
                estimatedHeight += 15; // Section header
                estimatedHeight += formData.education.length * 15;
            }
            
            return estimatedHeight;
        }
        
        // Determine scale factor
        const estimatedHeight = calculateEstimatedHeight();
        if (estimatedHeight > availableHeight) {
            scaleFactor = Math.max(0.7, availableHeight / estimatedHeight); // Minimum 70% scaling
        }
        
        // Scaled font sizes and spacing
        const fonts = {
            nameSize: Math.max(14, Math.floor(22 * scaleFactor)),
            sectionHeaderSize: Math.max(10, Math.floor(12 * scaleFactor)),
            jobTitleSize: Math.max(8, Math.floor(11 * scaleFactor)),
            bodySize: Math.max(8, Math.floor(10 * scaleFactor)),
            smallSize: Math.max(8, Math.floor(9 * scaleFactor))
        };
        
        const spacing = {
            afterHeader: Math.max(8, Math.floor(15 * scaleFactor)),
            afterSection: Math.max(5, Math.floor(8 * scaleFactor)),
            betweenItems: Math.max(3, Math.floor(5 * scaleFactor)),
            lineHeight: Math.max(3, Math.floor(4 * scaleFactor))
        };
        
        // No page breaks - single page only
        function checkSinglePageLimit() {
            return yPosition < pageHeight - margin - 15;
        }
        
        // Helper function to add colored rectangle
        function addColoredRect(x, y, width, height, color) {
            doc.setFillColor(...color);
            doc.rect(x, y, width, height, 'F');
        }
        
        // Helper function for section headers - Made smaller and scalable
        function addSectionHeader(title, color = primaryColor) {
            if (!checkSinglePageLimit()) return false;
            
            // Add thin colored line (1px height)
            addColoredRect(margin, yPosition, contentWidth, 1, separatorColor);
            yPosition += Math.max(4, Math.floor(6 * scaleFactor));
            
            // Add section title - Scaled size
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(fonts.sectionHeaderSize);
            doc.setTextColor(...color);
            doc.text(title.toUpperCase(), margin, yPosition);
            yPosition += spacing.afterSection;
            
            // Reset text color
            doc.setTextColor(...textColor);
            return true;
        }
        
        // Helper function for professional text with scaling
        function addFormattedText(text, fontSize = fonts.bodySize, fontWeight = 'normal', leftMargin = margin, maxWidth = contentWidth) {
            if (!checkSinglePageLimit()) return false;
            
            doc.setFont('helvetica', fontWeight);
            doc.setFontSize(fontSize);
            doc.setTextColor(...textColor);
            
            const lines = doc.splitTextToSize(text, maxWidth);
            lines.forEach((line, index) => {
                if (checkSinglePageLimit()) {
                    doc.text(line, leftMargin, yPosition);
                    yPosition += Math.max(3, fontSize * 0.35 + 1.5); // Tighter line spacing
                }
            });
            return true;
        }
        
        // Header Section with Central Alignment - Scaled
        function createHeader() {
            // Name - Centrally aligned with scaled font
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(fonts.nameSize);
            doc.setTextColor(...primaryColor);
            
            // Calculate center position for name
            const nameWidth = doc.getTextWidth(formData.name);
            const nameX = (pageWidth - nameWidth) / 2;
            doc.text(formData.name, nameX, yPosition + 5);
            
            yPosition += spacing.afterHeader; // Scaled spacing
            
            // Contact information in a clean row - Centrally aligned
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(fonts.smallSize);
            doc.setTextColor(...secondaryColor);
            
            // Prepare contact info with clickable LinkedIn
            const basicContactInfo = [
                formData.email,
                ...formData.mobileNumbers
            ].filter(item => item);
            
            let contactText = basicContactInfo.join(' ‚Ä¢ ');
            
            // Add LinkedIn if available
            if (formData.linkedinUrl) {
                contactText += ' ‚Ä¢ LinkedIn';
            }
            
            // Calculate center position for contact info
            const contactWidth = doc.getTextWidth(contactText);
            const contactX = (pageWidth - contactWidth) / 2;
            
            // Add basic contact info
            const basicContactText = basicContactInfo.join(' ‚Ä¢ ');
            let currentX = contactX;
            
            if (basicContactInfo.length > 0) {
                doc.text(basicContactText, currentX, yPosition);
                currentX += doc.getTextWidth(basicContactText);
                
                if (formData.linkedinUrl) {
                    doc.text(' ‚Ä¢ ', currentX, yPosition);
                    currentX += doc.getTextWidth(' ‚Ä¢ ');
                }
            }
            
            // Add clickable LinkedIn
            if (formData.linkedinUrl) {
                const linkedinText = 'LinkedIn';
                doc.setTextColor(0, 0, 255); // Blue color for link
                doc.text(linkedinText, currentX, yPosition);
                
                // Add clickable link
                const linkedinWidth = doc.getTextWidth(linkedinText);
                doc.link(currentX, yPosition - 4, linkedinWidth, 6, { url: formData.linkedinUrl });
                
                // Reset color
                doc.setTextColor(...secondaryColor);
            }
            
            yPosition += spacing.afterHeader; // Scaled spacing before professional summary
        }
        
        // Professional Summary with styling - Scaled
        function createProfessionalSummary() {
            if (!formData.professionalSummary || !checkSinglePageLimit()) return;
            
            if (!addSectionHeader('Professional Summary', primaryColor)) return;
            
            // Add summary with scaled styling
            const summaryHeight = Math.max(15, doc.splitTextToSize(formData.professionalSummary, contentWidth - 10).length * 4 + 6);
            addColoredRect(margin - 3, yPosition - 2, contentWidth + 6, summaryHeight, [248, 249, 250]);
            
            addFormattedText(formData.professionalSummary, fonts.bodySize, 'normal', margin, contentWidth - 6);
            yPosition += spacing.betweenItems;
        }
        
        // Professional Experience with enhanced formatting - Scaled
        function createExperience() {
            if (!formData.professionalExperience?.length || !checkSinglePageLimit()) return;
            
            if (!addSectionHeader('Professional Experience', primaryColor)) return;
            
            formData.professionalExperience.forEach((exp, index) => {
                if (!checkSinglePageLimit()) return;
                
                // Company and position
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(fonts.jobTitleSize);
                doc.setTextColor(...textColor);
                doc.text(exp.jobDesignation, margin, yPosition);
                
                // Company name and dates
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(fonts.smallSize);
                doc.setTextColor(...secondaryColor);
                const companyLine = `${exp.jobName} | ${exp.term}`;
                doc.text(companyLine, margin, yPosition + Math.max(4, fonts.jobTitleSize * 0.5));
                
                yPosition += Math.max(8, fonts.jobTitleSize + 2);
                
                // Achievements with bullet styling
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(fonts.smallSize);
                doc.setTextColor(...textColor);
                
                exp.jobDetails?.forEach(detail => {
                    if (!checkSinglePageLimit()) return;
                    
                    // Custom bullet point
                    doc.setFillColor(...accentColor);
                    doc.circle(margin + 1.5, yPosition - 1.5, 0.6, 'F');
                    
                    // Achievement text with tighter spacing
                    const lines = doc.splitTextToSize(detail, contentWidth - 12);
                    lines.forEach((line, lineIndex) => {
                        if (checkSinglePageLimit()) {
                            doc.text(line, margin + 6, yPosition);
                            if (lineIndex < lines.length - 1) {
                                yPosition += spacing.lineHeight;
                            }
                        }
                    });
                    yPosition += spacing.lineHeight;
                });
                
                // Minimal spacing between jobs
                yPosition += spacing.betweenItems;
            });
        }
        
        // Skills section with modern layout - Scaled
        function createSkills() {
            if (!formData.skills?.length || !checkSinglePageLimit()) return;
            
            if (!addSectionHeader('Core Competencies', primaryColor)) return;
            
            formData.skills.forEach(skillCategory => {
                if (!checkSinglePageLimit()) return;
                
                // Skill category
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(fonts.bodySize);
                doc.setTextColor(...primaryColor);
                doc.text(skillCategory.skillName + ':', margin, yPosition);
                
                // Skills with compact styling
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(fonts.smallSize);
                doc.setTextColor(...textColor);
                
                const skillsText = skillCategory.skills.join(' ‚Ä¢ ');
                const lines = doc.splitTextToSize(skillsText, contentWidth - 35);
                
                lines.forEach(line => {
                    if (checkSinglePageLimit()) {
                        yPosition += spacing.lineHeight;
                        doc.text(line, margin + 35, yPosition);
                    }
                });
                
                yPosition += spacing.betweenItems;
            });
        }
        
        // Education section - Scaled
        function createEducation() {
            if (!formData.education?.length || !checkSinglePageLimit()) return;
            
            if (!addSectionHeader('Education', primaryColor)) return;
            
            formData.education.forEach(edu => {
                if (!checkSinglePageLimit()) return;
                
                // Degree
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(fonts.bodySize);
                doc.setTextColor(...textColor);
                doc.text(edu.degree, margin, yPosition);
                
                // Institution and dates
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(fonts.smallSize);
                doc.setTextColor(...secondaryColor);
                const eduLine = `${edu.collegeName} | ${edu.tenure}`;
                doc.text(eduLine, margin, yPosition + Math.max(4, fonts.bodySize * 0.5));
                
                yPosition += Math.max(8, fonts.bodySize + 3);
            });
        }
        
        // Footer with modern touch - Single page only
        function createFooter() {
            const footerY = pageHeight - 10;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(Math.max(6, fonts.smallSize - 1));
            doc.setTextColor(...secondaryColor);
            
            const footerText = `${formData.name} ‚Ä¢ Professional Resume ‚Ä¢ Generated ${new Date().toLocaleDateString()}`;
            const textWidth = doc.getTextWidth(footerText);
            doc.text(footerText, (pageWidth - textWidth) / 2, footerY);
            
            // Footer line
            addColoredRect(margin, footerY - 3, contentWidth, 0.5, secondaryColor);
        }
        
        // Build the complete PDF - Single page optimized
        console.log(`Content scaling factor: ${scaleFactor.toFixed(2)} (${scaleFactor < 1 ? 'compressed' : 'normal'})`);
        
        createHeader();
        createProfessionalSummary();
        createExperience();
        createSkills();
        createEducation();
        
        // Not Adding 
        // Add footer to the single page
       // createFooter();
        
        // Check if content exceeded page and warn user
        if (yPosition > pageHeight - margin - 15) {
            console.warn('Content may have exceeded single page limits');
            // Use existing showAlert function or fallback to console
            if (typeof showAlert === 'function') {
                showAlert('‚ö†Ô∏è Content was compressed to fit one page. Consider reducing content for optimal formatting.', 'warning');
            } else {
                console.log('‚ö†Ô∏è Content was compressed to fit one page. Consider reducing content for optimal formatting.');
            }
        }
        
        // Save with formatted filename
        const fileName = `${formData.name.replace(/[^a-zA-Z0-9]/g, '_')}_Professional_Resume.pdf`;
        doc.save(fileName);
        
        // Use existing showAlert function or fallback to console
        if (typeof showAlert === 'function') {
            showAlert('‚ú® Single-page PDF exported successfully!', 'success');
        } else {
            console.log('‚ú® Single-page PDF exported successfully!');
        }
        
    } catch (error) {
        console.error('Error generating PDF:', error);
        // Use existing showAlert function or fallback to console
        if (typeof showAlert === 'function') {
            showAlert('Error generating PDF: ' + error.message, 'error');
        } else {
            console.error('Error generating PDF: ' + error.message);
        }
    }
}

// Alternative: Export with multiple template options
function exportPDFWithTemplate(templateStyle = 'modern') {
    const formData = collectFormData();
    
    const templates = {
        modern: {
            primaryColor: [79, 172, 254],
            accentColor: [40, 167, 69],
            backgroundColor: [248, 249, 250],
            fontFamily: 'helvetica'
        },
        professional: {
            primaryColor: [52, 58, 64],
            accentColor: [220, 53, 69],
            backgroundColor: [255, 255, 255],
            fontFamily: 'helvetica'
        },
        creative: {
            primaryColor: [102, 16, 242],
            accentColor: [255, 193, 7],
            backgroundColor: [248, 249, 250],
            fontFamily: 'helvetica'
        },
        executive: {
            primaryColor: [13, 27, 42],
            accentColor: [0, 123, 255],
            backgroundColor: [248, 249, 250],
            fontFamily: 'helvetica'
        }
    };
    
    const template = templates[templateStyle] || templates.modern;
    
    // Use the enhanced export function with template colors
    // (You would modify the enhanced function to accept template parameters)
    exportToPDFEnhanced();
}

        function exportToJSON() {
            const formData = collectFormData(selectedAIProvider);
            
            const dataStr = JSON.stringify(formData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${formData.name.replace(/[^a-zA-Z0-9]/g, '_')}_Resume.json`;
            link.click();
            
            showAlert('JSON exported successfully!', 'success');
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loadingSection').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingSection').classList.add('hidden');
        }

        function showResumeForm() {
            document.getElementById('selectionForm').classList.add('hidden');
            document.getElementById('resumeForm').classList.remove('hidden');
        }

        function resetForm() {
            if (confirm('Are you sure you want to reset the form? All changes will be lost.')) {
                location.reload();
            }
        }

        function showAlert(message, type = 'error') {
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }

            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            
            const targetContainer = document.getElementById('authSection').classList.contains('hidden') ? 
                document.querySelector('.main-content') : document.querySelector('.auth-container');
            
            targetContainer.insertBefore(alert, targetContainer.firstChild);
            
            setTimeout(() => alert.remove(), 5000);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const profileModal = document.getElementById('profileModal');
            const templateModal = document.getElementById('templateModal');
            
            if (event.target === profileModal) {
                closeProfileModal();
            }
            if (event.target === templateModal) {
                closeTemplateModal();
            }
        }
    </script>
</body>
</html>